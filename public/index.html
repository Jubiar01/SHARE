<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ShareBoost - Facebook Post Sharing Tool</title>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        sable: '#060606',
                        'sable-light': '#0c0c0c',
                        'sable-lighter': '#101010',
                        'sable-dark': '#050505',
                        accent: '#4d6dd3',
                        'accent-hover': '#3d5bc0',
                        success: '#48c774',
                        warning: '#ffdd57',
                        danger: '#f14668',
                        'border-color': '#2a2a2a',
                        'text-primary': '#ffffff',
                        'text-secondary': '#a0a0a0',
                        'text-muted': '#606060',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    boxShadow: {
                        'material': '0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24)',
                        'material-md': '0 3px 6px rgba(0,0,0,0.16), 0 3px 6px rgba(0,0,0,0.23)',
                        'material-lg': '0 10px 20px rgba(0,0,0,0.19), 0 6px 6px rgba(0,0,0,0.23)',
                    }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer components {
            .icon-box {
                @apply flex items-center justify-center w-10 h-10 bg-sable-lighter rounded-md shadow-material;
            }
            
            .card {
                @apply bg-sable rounded-lg p-6 shadow-material-md border border-border-color mb-6;
            }
            
            .btn {
                @apply flex items-center justify-center gap-2 px-4 py-2 rounded-md font-semibold transition-all duration-200 shadow-material;
            }
            
            .btn-primary {
                @apply btn bg-accent text-white hover:bg-accent-hover hover:shadow-material-md;
            }
            
            .btn-danger {
                @apply btn bg-danger text-white hover:opacity-90 hover:shadow-material-md;
            }
            
            .btn-outline {
                @apply btn bg-transparent border border-border-color text-text-secondary hover:border-text-primary hover:text-text-primary;
            }
            
            .progress-bar {
                @apply w-full h-2 bg-border-color rounded-full overflow-hidden;
            }
            
            .progress-fill {
                @apply h-full bg-accent transition-all duration-300;
            }
            
            .status-badge {
                @apply inline-flex items-center px-2 py-1 rounded text-sm font-medium;
            }
            
            .status-active {
                @apply bg-success bg-opacity-20 text-success;
            }
            
            .status-completed {
                @apply bg-success bg-opacity-20 text-success;
            }
            
            .status-stopped {
                @apply bg-warning bg-opacity-20 text-warning;
            }
            
            .status-error {
                @apply bg-danger bg-opacity-20 text-danger;
            }
            
            .form-label {
                @apply block mb-2 font-medium text-text-secondary;
            }
            
            .form-input {
                @apply w-full px-3 py-2 bg-sable-lighter border border-border-color rounded-md text-text-primary focus:outline-none focus:border-accent transition duration-200;
            }
            
            .tab-active {
                @apply text-accent border-b-2 border-accent;
            }
            
            .loader {
                @apply inline-block w-6 h-6 border-2 border-text-primary border-opacity-30 rounded-full border-t-text-primary animate-spin;
            }
            
            .table-cell {
                @apply px-3 py-2 border-b border-border-color;
            }
            
            .table-head {
                @apply px-3 py-2 text-left text-text-secondary border-b border-border-color font-semibold;
            }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes fadeOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
        
        .animate-fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }
        
        .animate-slide-in {
            animation: slideIn 0.3s ease-out forwards;
        }
        
        .animate-fade-out {
            animation: fadeOut 0.3s ease-out forwards;
        }
    </style>
</head>
<body class="bg-sable font-sans text-text-primary min-h-screen">
    <!-- Toast Notifications Container -->
    <div id="toasts" class="fixed bottom-5 right-5 z-50 flex flex-col gap-3 max-w-sm"></div>

    <!-- Header -->
    <header class="bg-sable sticky top-0 z-40 border-b border-border-color shadow-material-md">
        <div class="container mx-auto px-4">
            <div class="flex items-center justify-between py-4">
                <!-- Logo -->
                <div class="flex items-center gap-3">
                    <div class="icon-box">
                        <i class="ph-fill ph-share-network text-xl text-accent"></i>
                    </div>
                    <span class="text-xl font-bold">ShareBoost</span>
                </div>
                
                <!-- Mobile Menu Toggle -->
                <button id="menuToggle" class="md:hidden text-text-primary">
                    <i class="ph-fill ph-list text-2xl"></i>
                </button>
                
                <!-- Navigation -->
                <nav class="hidden md:block">
                    <ul id="navMenu" class="flex gap-6">
                        <li>
                            <a href="#" class="flex items-center gap-2 py-2 px-1 border-b-2 border-transparent hover:text-text-primary tab-active" data-tab="dashboard">
                                <div class="icon-box">
                                    <i class="ph-fill ph-chart-bar"></i>
                                </div>
                                <span>Dashboard</span>
                            </a>
                        </li>
                        <li>
                            <a href="#" class="flex items-center gap-2 py-2 px-1 border-b-2 border-transparent hover:text-text-primary" data-tab="new-session">
                                <div class="icon-box">
                                    <i class="ph-fill ph-plus"></i>
                                </div>
                                <span>New Session</span>
                            </a>
                        </li>
                        <li>
                            <a href="#" class="flex items-center gap-2 py-2 px-1 border-b-2 border-transparent hover:text-text-primary" data-tab="history">
                                <div class="icon-box">
                                    <i class="ph-fill ph-clock-counter-clockwise"></i>
                                </div>
                                <span>History</span>
                            </a>
                        </li>
                    </ul>
                </nav>
            </div>
            
            <!-- Mobile Navigation Menu -->
            <div id="mobileMenu" class="md:hidden hidden animate-fade-in">
                <ul class="py-3 border-t border-border-color">
                    <li class="py-2">
                        <a href="#" class="flex items-center gap-2 px-1 hover:text-accent" data-tab="dashboard">
                            <div class="icon-box">
                                <i class="ph-fill ph-chart-bar"></i>
                            </div>
                            <span>Dashboard</span>
                        </a>
                    </li>
                    <li class="py-2">
                        <a href="#" class="flex items-center gap-2 px-1 hover:text-accent" data-tab="new-session">
                            <div class="icon-box">
                                <i class="ph-fill ph-plus"></i>
                            </div>
                            <span>New Session</span>
                        </a>
                    </li>
                    <li class="py-2">
                        <a href="#" class="flex items-center gap-2 px-1 hover:text-accent" data-tab="history">
                            <div class="icon-box">
                                <i class="ph-fill ph-clock-counter-clockwise"></i>
                            </div>
                            <span>History</span>
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-6">
        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content">
            <!-- Stats Grid -->
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                <!-- Active Sessions Stat -->
                <div class="bg-sable rounded-lg p-4 shadow-material-md border border-border-color flex items-center gap-4">
                    <div class="icon-box">
                        <i class="ph-fill ph-activity text-xl text-accent"></i>
                    </div>
                    <div>
                        <div id="activeSessionsCount" class="text-3xl font-bold">0</div>
                        <div class="text-text-secondary text-sm">Active Sessions</div>
                    </div>
                </div>
                
                <!-- Total Shares Stat -->
                <div class="bg-sable rounded-lg p-4 shadow-material-md border border-border-color flex items-center gap-4">
                    <div class="icon-box">
                        <i class="ph-fill ph-share-network text-xl text-accent"></i>
                    </div>
                    <div>
                        <div id="totalSharesCount" class="text-3xl font-bold">0</div>
                        <div class="text-text-secondary text-sm">Total Shares</div>
                    </div>
                </div>
                
                <!-- Completed Sessions Stat -->
                <div class="bg-sable rounded-lg p-4 shadow-material-md border border-border-color flex items-center gap-4">
                    <div class="icon-box">
                        <i class="ph-fill ph-check-circle text-xl text-success"></i>
                    </div>
                    <div>
                        <div id="completedSessionsCount" class="text-3xl font-bold">0</div>
                        <div class="text-text-secondary text-sm">Completed Sessions</div>
                    </div>
                </div>
                
                <!-- Error Sessions Stat -->
                <div class="bg-sable rounded-lg p-4 shadow-material-md border border-border-color flex items-center gap-4">
                    <div class="icon-box">
                        <i class="ph-fill ph-warning-circle text-xl text-danger"></i>
                    </div>
                    <div>
                        <div id="errorSessionsCount" class="text-3xl font-bold">0</div>
                        <div class="text-text-secondary text-sm">Sessions With Errors</div>
                    </div>
                </div>
            </div>
            
            <!-- Active Sessions Card -->
            <div class="card">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="flex items-center gap-3 text-xl font-semibold">
                        <div class="icon-box">
                            <i class="ph-fill ph-activity text-accent"></i>
                        </div>
                        Active Sessions
                    </h2>
                </div>
                
                <!-- Search and Refresh -->
                <div class="flex flex-col sm:flex-row gap-3 mb-6">
                    <div class="relative flex-grow">
                        <i class="ph-fill ph-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-text-muted"></i>
                        <input type="text" id="sessionSearch" placeholder="Search sessions by URL or Post ID..." 
                               class="w-full pl-10 pr-3 py-2 bg-sable-lighter border border-border-color rounded-md text-text-primary focus:outline-none focus:border-accent">
                    </div>
                    <button id="refreshSessions" class="btn-outline whitespace-nowrap">
                        <i class="ph-fill ph-arrows-clockwise"></i>
                        Refresh
                    </button>
                </div>
                
                <!-- Sessions Table -->
                <div id="activeSessionsTable">
                    <!-- Empty State -->
                    <div id="noSessionsMessage" class="flex flex-col items-center justify-center py-12 text-center">
                        <div class="flex items-center justify-center w-16 h-16 bg-sable-lighter rounded-full mb-6 shadow-material">
                            <i class="ph-fill ph-database text-2xl text-text-muted"></i>
                        </div>
                        <p class="text-text-secondary mb-6">No active sessions found</p>
                        <button id="createFirstSession" class="btn-primary">
                            <i class="ph-fill ph-plus-circle"></i>
                            Create your first sharing session
                        </button>
                    </div>
                    
                    <!-- Sessions Table -->
                    <div id="sessionsTableContainer" class="hidden overflow-x-auto">
                        <table id="sessionsTable" class="w-full">
                            <thead>
                                <tr>
                                    <th class="table-head">Facebook Post</th>
                                    <th class="table-head">Progress</th>
                                    <th class="table-head">Status</th>
                                    <th class="table-head">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="sessionsTableBody">
                                <!-- Sessions will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Session Details Panel -->
            <div id="sessionDetails" class="card hidden">
                <h3 class="text-lg font-semibold mb-4">Session Details</h3>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <div class="text-text-secondary mb-1">Session ID:</div>
                        <div id="detailSessionId" class="font-medium break-all"></div>
                    </div>
                    
                    <div>
                        <div class="text-text-secondary mb-1">Status:</div>
                        <div id="detailStatus"></div>
                    </div>
                    
                    <div class="md:col-span-2">
                        <div class="text-text-secondary mb-1">Post URL:</div>
                        <div id="detailUrl" class="font-medium break-all"></div>
                    </div>
                    
                    <div>
                        <div class="text-text-secondary mb-1">Post ID:</div>
                        <div id="detailPostId" class="font-medium"></div>
                    </div>
                    
                    <div>
                        <div class="text-text-secondary mb-1">Progress:</div>
                        <div id="detailProgress" class="font-medium"></div>
                    </div>
                    
                    <div>
                        <div class="text-text-secondary mb-1">Start Time:</div>
                        <div id="detailStartTime" class="font-medium"></div>
                    </div>
                    
                    <div>
                        <div class="text-text-secondary mb-1">Expected End Time:</div>
                        <div id="detailEndTime" class="font-medium"></div>
                    </div>
                </div>
                
                <div class="flex gap-3 mt-6">
                    <button id="stopSessionBtn" class="btn-danger">
                        <i class="ph-fill ph-stop-circle"></i>
                        Stop Session
                    </button>
                    <button id="closeDetailBtn" class="btn-outline">
                        <i class="ph-fill ph-x"></i>
                        Close
                    </button>
                </div>
            </div>
        </div>

        <!-- New Session Tab -->
        <div id="new-session" class="tab-content hidden">
            <div class="card">
                <div class="flex items-center gap-3 mb-6">
                    <div class="icon-box">
                        <i class="ph-fill ph-plus-circle text-accent"></i>
                    </div>
                    <h2 class="text-xl font-semibold">Start New Share Session</h2>
                </div>
                
                <form id="shareForm">
                    <div class="mb-4">
                        <label for="fbUrl" class="form-label">Facebook Post URL</label>
                        <input type="url" id="fbUrl" placeholder="https://www.facebook.com/..." 
                               class="form-input" required>
                    </div>
                    
                    <div class="mb-4">
                        <label for="fbCookie" class="form-label">Facebook Cookies (JSON format)</label>
                        <textarea id="fbCookie" rows="6" placeholder='[{"key": "sb", "value": "..."}, {"key": "c_user", "value": "..."}, ...]'
                                  class="form-input" required></textarea>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        <div>
                            <label for="shareAmount" class="form-label">Number of Shares</label>
                            <input type="number" id="shareAmount" min="1" max="1000" value="50"
                                   class="form-input" required>
                        </div>
                        
                        <div>
                            <label for="shareInterval" class="form-label">Interval Between Shares (seconds)</label>
                            <input type="number" id="shareInterval" min="5" max="600" value="30"
                                   class="form-input" required>
                        </div>
                    </div>
                    
                    <div class="flex flex-col sm:flex-row gap-3">
                        <button type="submit" id="startSharingBtn" class="btn-primary">
                            <i class="ph-fill ph-play"></i>
                            Start Sharing
                        </button>
                        <button type="reset" class="btn-outline">
                            <i class="ph-fill ph-x"></i>
                            Clear Form
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- History Tab -->
        <div id="history" class="tab-content hidden">
            <div class="card">
                <div class="flex items-center gap-3 mb-6">
                    <div class="icon-box">
                        <i class="ph-fill ph-clock-counter-clockwise text-accent"></i>
                    </div>
                    <h2 class="text-xl font-semibold">Session History</h2>
                </div>
                
                <div class="flex flex-col sm:flex-row gap-3 mb-6">
                    <div class="relative flex-grow">
                        <i class="ph-fill ph-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-text-muted"></i>
                        <input type="text" id="historySearch" placeholder="Search by URL or Post ID..." 
                               class="w-full pl-10 pr-3 py-2 bg-sable-lighter border border-border-color rounded-md text-text-primary focus:outline-none focus:border-accent">
                    </div>
                    <button id="searchHistoryBtn" class="btn-primary whitespace-nowrap">
                        <i class="ph-fill ph-magnifying-glass"></i>
                        Search
                    </button>
                </div>
                
                <div id="historyResults">
                    <div class="flex flex-col items-center justify-center py-12 text-center">
                        <div class="flex items-center justify-center w-16 h-16 bg-sable-lighter rounded-full mb-6 shadow-material">
                            <i class="ph-fill ph-clock-counter-clockwise text-2xl text-text-muted"></i>
                        </div>
                        <p class="text-text-secondary">No session history found</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // DOM Elements
        const elements = {
            // Navigation
            navLinks: document.querySelectorAll('[data-tab]'),
            tabContents: document.querySelectorAll('.tab-content'),
            menuToggle: document.getElementById('menuToggle'),
            mobileMenu: document.getElementById('mobileMenu'),
            
            // Dashboard
            activeSessionsCount: document.getElementById('activeSessionsCount'),
            totalSharesCount: document.getElementById('totalSharesCount'),
            completedSessionsCount: document.getElementById('completedSessionsCount'),
            errorSessionsCount: document.getElementById('errorSessionsCount'),
            sessionsTableContainer: document.getElementById('sessionsTableContainer'),
            sessionsTable: document.getElementById('sessionsTable'),
            sessionsTableBody: document.getElementById('sessionsTableBody'),
            noSessionsMessage: document.getElementById('noSessionsMessage'),
            sessionSearch: document.getElementById('sessionSearch'),
            refreshSessions: document.getElementById('refreshSessions'),
            createFirstSession: document.getElementById('createFirstSession'),
            
            // Session Details
            sessionDetails: document.getElementById('sessionDetails'),
            detailSessionId: document.getElementById('detailSessionId'),
            detailUrl: document.getElementById('detailUrl'),
            detailPostId: document.getElementById('detailPostId'),
            detailStartTime: document.getElementById('detailStartTime'),
            detailEndTime: document.getElementById('detailEndTime'),
            detailStatus: document.getElementById('detailStatus'),
            detailProgress: document.getElementById('detailProgress'),
            stopSessionBtn: document.getElementById('stopSessionBtn'),
            closeDetailBtn: document.getElementById('closeDetailBtn'),
            
            // New Session
            shareForm: document.getElementById('shareForm'),
            fbUrl: document.getElementById('fbUrl'),
            fbCookie: document.getElementById('fbCookie'),
            shareAmount: document.getElementById('shareAmount'),
            shareInterval: document.getElementById('shareInterval'),
            startSharingBtn: document.getElementById('startSharingBtn'),
            
            // History
            historySearch: document.getElementById('historySearch'),
            searchHistoryBtn: document.getElementById('searchHistoryBtn'),
            historyResults: document.getElementById('historyResults'),
            
            // Toast container
            toasts: document.getElementById('toasts')
        };

        // State management
        const state = {
            activeSessions: [],
            selectedSessionId: null,
            refreshInterval: null,
            isLoading: false
        };

        // Tab navigation
        function activateTab(tabId) {
            // Update nav links
            elements.navLinks.forEach(link => {
                if (link.getAttribute('data-tab') === tabId) {
                    link.classList.add('tab-active');
                } else {
                    link.classList.remove('tab-active');
                }
            });
            
            // Update tab content
            elements.tabContents.forEach(content => {
                if (content.id === tabId) {
                    content.classList.remove('hidden');
                    
                    // Load data for specific tabs
                    if (tabId === 'dashboard') {
                        loadSessions();
                        startAutoRefresh();
                    } else {
                        stopAutoRefresh();
                    }
                } else {
                    content.classList.add('hidden');
                }
            });
            
            // Close mobile menu
            elements.mobileMenu.classList.add('hidden');
        }

        // Load active sessions
        async function loadSessions() {
            try {
                state.isLoading = true;
                showLoader(elements.sessionsTableBody);
                
                const response = await fetch('/sessions');
                const data = await response.json();
                
                state.activeSessions = data;
                updateDashboardStats();
                renderSessionsTable();
                
                state.isLoading = false;
            } catch (error) {
                showToast('Error loading sessions: ' + error.message, 'error');
                state.isLoading = false;
            }
        }

        // Show loader in table
        function showLoader(container) {
            container.innerHTML = `
                <tr>
                    <td colspan="4" class="text-center py-8">
                        <div class="flex flex-col items-center">
                            <div class="loader mb-3"></div>
                            <div class="text-text-secondary">Loading sessions...</div>
                        </div>
                    </td>
                </tr>
            `;
        }

        // Render sessions table
        function renderSessionsTable() {
            const { activeSessions } = state;
            
            if (activeSessions.length === 0) {
                elements.sessionsTableContainer.classList.add('hidden');
                elements.noSessionsMessage.classList.remove('hidden');
                return;
            }
            
            elements.sessionsTableContainer.classList.remove('hidden');
            elements.noSessionsMessage.classList.add('hidden');
            
            // Clear table
            elements.sessionsTableBody.innerHTML = '';
            
            // Add session rows
            activeSessions.forEach(session => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-sable-lighter transition duration-150';
                row.setAttribute('data-session-id', session.sessionId);
                
                // URL cell
                const urlCell = document.createElement('td');
                urlCell.className = 'table-cell';
                urlCell.innerHTML = `
                    <div class="max-w-xs overflow-hidden text-ellipsis">
                        ${session.url}
                    </div>
                `;
                
                // Progress cell
                const progressCell = document.createElement('td');
                progressCell.className = 'table-cell';
                progressCell.innerHTML = `
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${session.progress}%"></div>
                    </div>
                    <div class="mt-1 text-sm">
                        ${session.count} / ${session.target} (${session.progress}%)
                    </div>
                `;
                
                // Status cell
                const statusCell = document.createElement('td');
                statusCell.className = 'table-cell';
                statusCell.innerHTML = `
                    <span class="status-badge status-${session.status.toLowerCase()}">
                        ${getStatusIcon(session.status)} ${session.status}
                    </span>
                `;
                
                // Actions cell
                const actionsCell = document.createElement('td');
                actionsCell.className = 'table-cell';
                actionsCell.innerHTML = `
                    <div class="flex gap-2">
                        <button class="view-session btn-outline !p-2">
                            <i class="ph-fill ph-eye"></i>
                        </button>
                        <button class="stop-session btn-danger !p-2">
                            <i class="ph-fill ph-stop-circle"></i>
                        </button>
                    </div>
                `;
                
                // Append cells to row
                row.appendChild(urlCell);
                row.appendChild(progressCell);
                row.appendChild(statusCell);
                row.appendChild(actionsCell);
                
                // Add row to table
                elements.sessionsTableBody.appendChild(row);
                
                // Add event listeners
                const viewButton = row.querySelector('.view-session');
                viewButton.addEventListener('click', () => showSessionDetails(session.sessionId));
                
                const stopButton = row.querySelector('.stop-session');
                stopButton.addEventListener('click', () => stopSession(session.sessionId));
                
                // Make entire row clickable
                row.addEventListener('click', (e) => {
                    // Don't trigger if clicking on buttons
                    if (!e.target.closest('button')) {
                        showSessionDetails(session.sessionId);
                    }
                });
            });
        }

        // Get status icon based on status
        function getStatusIcon(status) {
            const statusLower = status.toLowerCase();
            if (statusLower === 'active') {
                return '<i class="ph-fill ph-play"></i>';
            } else if (statusLower === 'completed') {
                return '<i class="ph-fill ph-check-circle"></i>';
            } else if (statusLower === 'stopped') {
                return '<i class="ph-fill ph-stop-circle"></i>';
            } else if (statusLower === 'error') {
                return '<i class="ph-fill ph-warning-circle"></i>';
            }
            return '<i class="ph-fill ph-question"></i>';
        }
        
        // Show session details
        function showSessionDetails(sessionId) {
            const session = state.activeSessions.find(s => s.sessionId === sessionId);
            
            if (!session) {
                showToast('Session not found', 'error');
                return;
            }
            
            // Update state
            state.selectedSessionId = sessionId;
            
            // Fill details
            elements.detailSessionId.textContent = session.sessionId;
            elements.detailUrl.textContent = session.url;
            elements.detailPostId.textContent = session.postId || 'N/A';
            elements.detailStartTime.textContent = new Date(session.startTime).toLocaleString();
            elements.detailEndTime.textContent = session.estimatedEndTime ? new Date(session.estimatedEndTime).toLocaleString() : 'N/A';
            
            // Status with badge
            elements.detailStatus.innerHTML = `
                <span class="status-badge status-${session.status.toLowerCase()}">
                    ${getStatusIcon(session.status)} ${session.status}
                </span>
            `;
            
            // Progress with bar
            elements.detailProgress.innerHTML = `
                <div class="progress-bar mt-1">
                    <div class="progress-fill" style="width: ${session.progress}%"></div>
                </div>
                <div class="mt-1 text-sm">
                    ${session.count} / ${session.target} (${session.progress}%)
                </div>
            `;
            
            // Show details panel with animation
            elements.sessionDetails.classList.remove('hidden');
            elements.sessionDetails.classList.add('animate-fade-in');
            
            // Update stop button state
            if (session.status.toLowerCase() === 'active') {
                elements.stopSessionBtn.classList.remove('hidden');
            } else {
                elements.stopSessionBtn.classList.add('hidden');
            }
        }
        
        // Update dashboard statistics
        function updateDashboardStats() {
            const { activeSessions } = state;
            
            // Count active, completed, and error sessions
            let activeCount = 0;
            let completedCount = 0;
            let errorCount = 0;
            let totalShares = 0;
            
            activeSessions.forEach(session => {
                totalShares += session.count;
                
                if (session.status.toLowerCase() === 'active') {
                    activeCount++;
                } else if (session.status.toLowerCase() === 'completed') {
                    completedCount++;
                } else if (session.status.toLowerCase() === 'error') {
                    errorCount++;
                }
            });
            
            // Update counters with animation
            animateCounter(elements.activeSessionsCount, activeCount);
            animateCounter(elements.totalSharesCount, totalShares);
            animateCounter(elements.completedSessionsCount, completedCount);
            animateCounter(elements.errorSessionsCount, errorCount);
        }
        
        // Animate counter
        function animateCounter(element, targetValue) {
            const currentValue = parseInt(element.textContent) || 0;
            const diff = targetValue - currentValue;
            
            if (diff === 0) return;
            
            const duration = 500; // ms
            const steps = 20;
            const stepValue = diff / steps;
            let currentStep = 0;
            
            const interval = setInterval(() => {
                currentStep++;
                const newValue = Math.round(currentValue + (stepValue * currentStep));
                
                if (currentStep >= steps) {
                    clearInterval(interval);
                    element.textContent = targetValue;
                } else {
                    element.textContent = newValue;
                }
            }, duration / steps);
        }
        
        // Filter sessions based on search term
        function filterSessions(searchTerm) {
            if (!searchTerm) {
                renderSessionsTable();
                return;
            }
            
            const searchLower = searchTerm.toLowerCase();
            const filtered = state.activeSessions.filter(session => 
                session.url.toLowerCase().includes(searchLower) || 
                session.sessionId.toLowerCase().includes(searchLower) ||
                (session.postId && session.postId.toString().includes(searchLower))
            );
            
            // Temporarily update state for rendering
            const originalSessions = state.activeSessions;
            state.activeSessions = filtered;
            renderSessionsTable();
            state.activeSessions = originalSessions;
        }
        
        // Stop a session
        async function stopSession(sessionId) {
            try {
                const response = await fetch('/api/stop', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ sessionId })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to stop session');
                }
                
                showToast('Session stopped successfully', 'success');
                loadSessions();
                
                // Close details panel if it's the current session
                if (state.selectedSessionId === sessionId) {
                    closeSessionDetails();
                }
            } catch (error) {
                showToast('Error stopping session: ' + error.message, 'error');
            }
        }
        
        // Close session details panel
        function closeSessionDetails() {
            elements.sessionDetails.classList.add('animate-fade-out');
            setTimeout(() => {
                elements.sessionDetails.classList.add('hidden');
                elements.sessionDetails.classList.remove('animate-fade-out');
                state.selectedSessionId = null;
            }, 300);
        }
        
        // Start a new sharing session
        async function startNewSession() {
            try {
                // Disable form
                elements.startSharingBtn.disabled = true;
                elements.startSharingBtn.innerHTML = '<div class="loader"></div> Starting...';
                
                // Get form values
                const url = elements.fbUrl.value;
                const cookie = elements.fbCookie.value;
                const amount = parseInt(elements.shareAmount.value);
                const interval = parseInt(elements.shareInterval.value);
                
                // Validate input
                if (!url || !url.includes('facebook.com')) {
                    throw new Error('Please enter a valid Facebook URL');
                }
                
                if (!cookie) {
                    throw new Error('Please enter your Facebook cookies');
                }
                
                if (isNaN(amount) || amount < 1) {
                    throw new Error('Please enter a valid number of shares');
                }
                
                if (isNaN(interval) || interval < 5) {
                    throw new Error('Interval must be at least 5 seconds');
                }
                
                // Send request
                const response = await fetch('/api/share', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        url,
                        cookie,
                        amount,
                        interval
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to start sharing session');
                }
                
                const result = await response.json();
                
                // Show success message
                showToast('Sharing session started successfully!', 'success');
                
                // Reset form
                elements.shareForm.reset();
                
                // Switch to dashboard tab
                activateTab('dashboard');
                
            } catch (error) {
                showToast('Error: ' + error.message, 'error');
            } finally {
                // Re-enable form
                elements.startSharingBtn.disabled = false;
                elements.startSharingBtn.innerHTML = '<i class="ph-fill ph-play"></i> Start Sharing';
            }
        }
        
        // Show toast notification
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `flex items-start gap-2 p-4 rounded-md shadow-material-md animate-slide-in ${
                type === 'success' ? 'bg-success text-white' : 'bg-danger text-white'
            }`;
            
            const icon = type === 'success' 
                ? '<i class="ph-fill ph-check-circle text-xl"></i>' 
                : '<i class="ph-fill ph-x-circle text-xl"></i>';
            
            toast.innerHTML = `
                <div class="flex-grow">
                    ${icon}
                    <div class="mt-1">${message}</div>
                </div>
                <button class="text-white opacity-70 hover:opacity-100">
                    <i class="ph-fill ph-x"></i>
                </button>
            `;
            
            elements.toasts.appendChild(toast);
            
            // Add event listener to close button
            const closeButton = toast.querySelector('button');
            closeButton.addEventListener('click', () => {
                toast.classList.add('animate-fade-out');
                setTimeout(() => {
                    if (elements.toasts.contains(toast)) {
                        elements.toasts.removeChild(toast);
                    }
                }, 300);
            });
            
            // Auto-close after 5 seconds
            setTimeout(() => {
                if (elements.toasts.contains(toast)) {
                    toast.classList.add('animate-fade-out');
                    setTimeout(() => {
                        if (elements.toasts.contains(toast)) {
                            elements.toasts.removeChild(toast);
                        }
                    }, 300);
                }
            }, 5000);
        }
        
        // Auto-refresh dashboard
        function startAutoRefresh() {
            if (state.refreshInterval) {
                clearInterval(state.refreshInterval);
            }
            
            state.refreshInterval = setInterval(() => {
                if (!state.isLoading) {
                    loadSessions();
                }
            }, 10000);
        }
        
        // Stop auto-refresh
        function stopAutoRefresh() {
            if (state.refreshInterval) {
                clearInterval(state.refreshInterval);
                state.refreshInterval = null;
            }
        }
        
        // Search history
        async function searchHistory() {
            try {
                const searchTerm = elements.historySearch.value;
                
                if (!searchTerm) {
                    showToast('Please enter a search term', 'error');
                    return;
                }
                
                // Show loading state
                elements.historyResults.innerHTML = `
                    <div class="flex flex-col items-center justify-center py-12">
                        <div class="loader mb-4"></div>
                        <div class="text-text-secondary">Searching...</div>
                    </div>
                `;
                
                const response = await fetch(`/api/search?term=${encodeURIComponent(searchTerm)}`);
                const data = await response.json();
                
                renderHistoryResults(data);
            } catch (error) {
                showToast('Error searching history: ' + error.message, 'error');
            }
        }
        
        // Render history search results
        function renderHistoryResults(data) {
            const { results, count, term } = data;
            
            if (count === 0) {
                elements.historyResults.innerHTML = `
                    <div class="flex flex-col items-center justify-center py-12 text-center">
                        <div class="flex items-center justify-center w-16 h-16 bg-sable-lighter rounded-full mb-6 shadow-material">
                            <i class="ph-fill ph-magnifying-glass text-2xl text-text-muted"></i>
                        </div>
                        <p class="text-text-secondary">No results found for "${term}"</p>
                    </div>
                `;
                return;
            }
            
            // Render results table
            let html = `
                <div class="mb-4">Found ${count} result(s) for "${term}"</div>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr>
                                <th class="table-head">Post URL</th>
                                <th class="table-head">Progress</th>
                                <th class="table-head">Status</th>
                                <th class="table-head">Start Time</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            results.forEach(session => {
                html += `
                    <tr class="hover:bg-sable-lighter transition duration-150">
                        <td class="table-cell">
                            <div class="max-w-xs overflow-hidden text-ellipsis">
                                ${session.url}
                            </div>
                        </td>
                        <td class="table-cell">
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${session.progress}%"></div>
                            </div>
                            <div class="mt-1 text-sm">
                                ${session.count} / ${session.target} (${session.progress}%)
                            </div>
                        </td>
                        <td class="table-cell">
                            <span class="status-badge status-${session.status.toLowerCase()}">
                                ${getStatusIcon(session.status)} ${session.status}
                            </span>
                        </td>
                        <td class="table-cell">
                            ${new Date(session.startTime).toLocaleString()}
                        </td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
            
            elements.historyResults.innerHTML = html;
        }
        
        // Helper function for debouncing
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
        
        // Initialize app
        function init() {
            // Tab navigation
            elements.navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const tabId = link.getAttribute('data-tab');
                    activateTab(tabId);
                });
            });
            
            // Mobile menu toggle
            elements.menuToggle.addEventListener('click', () => {
                elements.mobileMenu.classList.toggle('hidden');
            });
            
            // Create first session button
            elements.createFirstSession.addEventListener('click', () => {
                activateTab('new-session');
            });
            
            // Refresh sessions button
            elements.refreshSessions.addEventListener('click', () => {
                loadSessions();
            });
            
            // Session search
            elements.sessionSearch.addEventListener('input', debounce(() => {
                filterSessions(elements.sessionSearch.value);
            }, 300));
            
            // Share form submission
            elements.shareForm.addEventListener('submit', (e) => {
                e.preventDefault();
                startNewSession();
            });
            
            // Close session details
            elements.closeDetailBtn.addEventListener('click', closeSessionDetails);
            
            // Stop session
            elements.stopSessionBtn.addEventListener('click', () => {
                if (state.selectedSessionId) {
                    stopSession(state.selectedSessionId);
                }
            });
            
            // Search history
            elements.searchHistoryBtn.addEventListener('click', () => {
                searchHistory();
            });
            
            elements.historySearch.addEventListener('keyup', (e) => {
                if (e.key === 'Enter') {
                    searchHistory();
                }
            });
            
            // Initial load
            activateTab('dashboard');
        }
        
        // Start the app
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
